<div class="container">
  <header>
    <h1>Gestionnaire de Tâches</h1>
    <div class="header-actions">
      <button (click)="syncTodos()" class="btn btn-primary">
        Synchroniser avec JSONPlaceholder
      </button>
      <button (click)="downloadUsersListPdf()" class="btn btn-success">
        Imprimer Liste des Utilisateurs (PDF)
      </button>
    </div>
  </header>

  <!-- Formulaire de création -->
  <div class="form-section" *ngIf="!isEditing">
    <h2>Créer une nouvelle tâche</h2>
    <div class="form-group">
      <input [(ngModel)]="newTodo.username" placeholder="Nom d'utilisateur" class="form-control" />
      <input [(ngModel)]="newTodo.title" placeholder="Titre de la tâche" class="form-control" />
      <label class="checkbox-label">
        <input type="checkbox" [(ngModel)]="newTodo.completed" />
        Complétée
      </label>
      <button (click)="createTodo()" class="btn btn-primary">Créer</button>
    </div>
  </div>

  <!-- Formulaire d'édition -->
  <div class="form-section" *ngIf="isEditing && selectedTodo">
    <h2>Modifier la tâche</h2>
    <div class="form-group">
      <input [(ngModel)]="selectedTodo.username" placeholder="Nom d'utilisateur" class="form-control" />
      <input [(ngModel)]="selectedTodo.title" placeholder="Titre de la tâche" class="form-control" />
      <label class="checkbox-label">
        <input type="checkbox" [(ngModel)]="selectedTodo.completed" />
        Complétée
      </label>
      <div class="button-group">
        <button (click)="updateTodo()" class="btn btn-success">Enregistrer</button>
        <button (click)="cancelEdit()" class="btn btn-secondary">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Liste des tâches -->
  <div class="todos-section">
    <h2>Liste des Tâches ({{ totalElements }})</h2>
    <div class="todos-grid">
      <div *ngFor="let todo of todos" class="todo-card" [class.completed]="todo.completed">
        <div class="todo-header">
          <h3>{{ todo.title }}</h3>
          <span class="status-badge" [class.completed]="todo.completed">
            {{ todo.completed ? 'Complétée' : 'En cours' }}
          </span>
        </div>
        <p class="username">Utilisateur: {{ todo.username }}</p>
        <p class="todo-id">ID: {{ todo.id }}</p>

        <div class="todo-actions">
          <button (click)="editTodo(todo)" class="btn btn-sm btn-warning">
            Modifier
          </button>
          <button (click)="deleteTodo(todo.id)" class="btn btn-sm btn-danger">
            Supprimer
          </button>
          <button (click)="downloadTodoPdf(todo.id)" class="btn btn-sm btn-info">
            PDF Simple
          </button>
          <button (click)="openSignatureModal(todo)" class="btn btn-sm btn-success">
            PDF + Signature
          </button>
        </div>
      </div>
    </div>

    <!-- Pagination -->
    <div class="pagination-container" *ngIf="totalPages > 1">
      <div class="pagination-info">
        Page {{ currentPage + 1 }} sur {{ totalPages }} ({{ totalElements }} tâches)
      </div>
      <div class="pagination-controls">
        <button (click)="previousPage()" [disabled]="currentPage === 0" class="page-btn" title="Précédent">
          &lt;
        </button>

        <div class="page-numbers">
          <button *ngFor="let page of getPages()" (click)="onPageChange(page)" [class.active]="currentPage === page"
            class="page-btn">
            {{ page + 1 }}
          </button>
        </div>

        <button (click)="nextPage()" [disabled]="currentPage === totalPages - 1" class="page-btn" title="Suivant">
          &gt;
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de signature -->
<div class="modal-overlay" *ngIf="showSignatureModal" (click)="closeSignatureModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h2>Signer la tâche: {{ todoToSign?.title }}</h2>
    <p>Dessinez votre signature ci-dessous:</p>

    <canvas #signatureCanvas width="500" height="200" class="signature-canvas" (mousedown)="startDrawing($event)"
      (mousemove)="draw($event)" (mouseup)="stopDrawing()" (mouseleave)="stopDrawing()"></canvas>

    <div class="modal-actions">
      <button (click)="clearSignature()" class="btn btn-secondary">
        Effacer
      </button>
      <button (click)="saveSignedPdf()" class="btn btn-success">
        Télécharger PDF Signé
      </button>
      <button (click)="closeSignatureModal()" class="btn btn-danger">
        Fermer
      </button>
    </div>
  </div>
</div>